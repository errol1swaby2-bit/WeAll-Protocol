version: "3.9"

services:
  weall-node:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: weall-node
    restart: unless-stopped

    # IMPORTANT: In production, do NOT publish this directly to the internet.
    # Put a reverse proxy (Cloudflare Tunnel, nginx, Caddy, etc.) in front and
    # restrict inbound traffic so only the proxy can reach this port.
    ports:
      - "8000:8000"

    environment:
      # -------------------- Core mode --------------------
      # prod | genesis | testnet
      WEALL_MODE: "prod"

      # NEVER enable in production.
      WEALL_UNSAFE_DEV: "0"
      WEALL_ALLOW_UNSIGNED_TXS: "0"

      # -------------------- Networking / BFT --------------------
      # If you set either to "1", scripts/run_node.sh will require identity keys.
      WEALL_NET_ENABLED: "1"
      WEALL_BFT_ENABLED: "1"

      # Optional: validator account identity used by BFT (recommended)
      WEALL_VALIDATOR_ACCOUNT_FILE: "/run/secrets/weall_validator_account"

      # Node identity keys are loaded from docker secrets files
      WEALL_NODE_PUBKEY_FILE: "/run/secrets/weall_node_pubkey"
      WEALL_NODE_PRIVKEY_FILE: "/run/secrets/weall_node_privkey"

      # -------------------- SQLite durability --------------------
      # Allowed: OFF | NORMAL | FULL | EXTRA
      # Default for prod is FULL (see sqlite_db.py), but set explicitly anyway.
      WEALL_SQLITE_SYNCHRONOUS: "FULL"

      # -------------------- Public debug endpoints --------------------
      # /net/peers is fail-closed in prod unless explicitly enabled.
      WEALL_ENABLE_PUBLIC_DEBUG: "0"

      # -------------------- Request limits / abuse controls --------------------
      WEALL_MAX_REQUEST_BYTES: "1000000"

      # -------------------- Reverse proxy trust --------------------
      # Only set WEALL_TRUST_PROXY_HEADERS=1 if:
      #  - you are behind a reverse proxy that STRIPS and SETS proxy headers, AND
      #  - you also set WEALL_TRUSTED_PROXY_IPS to ONLY the IPs/CIDRs of that proxy.
      #
      # Fail-closed: in prod, trusting proxy headers without a trusted allowlist
      # is disabled by default by security.py.
      WEALL_TRUST_PROXY_HEADERS: "0"
      WEALL_TRUSTED_PROXY_IPS: ""

      # -------------------- IPFS integration --------------------
      # If you want node-backed media:
      WEALL_IPFS_ENABLED: "1"
      WEALL_IPFS_API_BASE: "http://kubo:5001"
      WEALL_IPFS_GATEWAY_BASE: "http://kubo:8080"
      WEALL_IPFS_MAX_UPLOAD_BYTES: "10485760"

      # -------------------- Optional CORS --------------------
      # Fail-closed default (no CORS). If you run a separate web frontend, set:
      # WEALL_CORS_ORIGINS: "https://your-frontend.example"
      # WEALL_CORS_ORIGINS: ""

      # -------------------- Optional gunicorn tuning --------------------
      # GUNICORN_WORKERS: "2"
      # GUNICORN_TIMEOUT: "60"

    secrets:
      - weall_node_privkey
      - weall_node_pubkey
      - weall_validator_account

    volumes:
      # Persistent node data (ledger snapshot, blocks, mempool/attestations)
      - weall_data:/app/data

    # Launch via wrapper that loads secrets into env at runtime
    command: ["sh", "-c", "/app/scripts/run_node.sh"]

    # Basic liveness. (Assumes /health exists and is fast.)
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:8000/health').read(); print('ok')"]
      interval: 15s
      timeout: 5s
      retries: 10

    # Conservative security posture (works for most deployments).
    # If you need to write elsewhere, add explicit mounts.
    read_only: true
    tmpfs:
      - /tmp

    # If you deploy behind a reverse proxy, restrict inbound traffic at the network level.
    networks:
      - weall_net

    depends_on:
      - kubo

  kubo:
    image: ipfs/kubo:v0.26.0
    # Pin this intentionally. Avoid :latest in production for reproducibility.
    container_name: weall-kubo
    restart: unless-stopped

    environment:
      # Optional: reduce log noise
      IPFS_LOGGING: "info"

    volumes:
      - ipfs_staging:/export
      - ipfs_data:/data/ipfs

    # For production, you usually do NOT want to expose these publicly.
    # Keep them internal and let the node talk to Kubo over the docker network.
    # If you need local debugging, uncomment:
    # ports:
    #   - "5001:5001"   # Kubo API
    #   - "8080:8080"   # Gateway

    networks:
      - weall_net

networks:
  weall_net:
    driver: bridge

volumes:
  weall_data:
  ipfs_data:
  ipfs_staging:

secrets:
  # Create these files on the host (NOT committed), e.g.:
  #   ./secrets/weall_node_privkey
  #   ./secrets/weall_node_pubkey
  #   ./secrets/weall_validator_account
  weall_node_privkey:
    file: ./secrets/weall_node_privkey
  weall_node_pubkey:
    file: ./secrets/weall_node_pubkey
  weall_validator_account:
    file: ./secrets/weall_validator_account
